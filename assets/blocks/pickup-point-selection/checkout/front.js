(()=>{"use strict";const e=window.wc.blocksCheckout,t=window.React,i=window.wp.element,p=window.wp.data,o=window.wp.components,a=window.wp.i18n,n=wcSettings["posti-blocks_data"].txt,s=((0,a.__)("Block options","woo-pakettikauppa"),(0,a.__)("Pickup point","woo-pakettikauppa"),(0,a.__)("Select a pickup point","woo-pakettikauppa"),(0,a.__)("No pickup point: Send to the street address","woo-pakettikauppa"),(0,a.__)("Other","woo-pakettikauppa"),(0,a.__)("Please choose a pickup point","woo-pakettikauppa"),(0,a.__)("No pickup points were found. Check the address.","woo-pakettikauppa"),(0,a.__)("You can choose the pickup point on the Checkout page","woo-pakettikauppa"),(0,a.__)("Choose one of pickup points close to the address you entered","woo-pakettikauppa"),(0,a.__)("Custom pickup address","woo-pakettikauppa"),(0,a.__)("If none of your preferred pickup points are listed, fill in a custom address above and select another pickup point","woo-pakettikauppa"),(0,a.__)("After entering, please wait for a while for the results to be received","woo-pakettikauppa"),(0,a.__)("The value is too short","woo-pakettikauppa"),(0,a.__)("Invalid character entered","woo-pakettikauppa"),(0,a.__)("The selection of pickup points has been changed based on the address %s","woo-pakettikauppa"),(e,t=!0)=>{if(!e.length)return null;let i=[];for(let t=0;t<e.length;t++)e[t].destination&&i.push(e[t].destination);return i.length?t?i[0]:i:null}),c=()=>wcSettings&&wcSettings["posti-blocks_data"]?wcSettings["posti-blocks_data"]:[],l=e=>{let t=c();if("methods"in t)for(let i=0;i<t.methods.length;i++)if(t.methods[i].instance_id==e&&t.methods[i].pickup_required)return!0;return!1},u=e=>!/[`!@#$%^*_+=\[\]{};:|<>\/?~]/.test(e),r=JSON.parse('{"apiVersion":2,"name":"pakettikauppa/pickup-point-selection-checkout","version":"1.0.0","title":"Posti pickup point selection","category":"woocommerce","description":"Allow to add components for Pakettikauppa shipping method on Checkout page","parent":["woocommerce/checkout-shipping-methods-block"],"supports":{"html":false,"align":false,"multiple":false,"reusable":false},"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}},"text":{"type":"string","default":""}},"textdomain":"woo-pakettikauppa"}');(0,e.registerCheckoutBlock)({metadata:r,component:({checkoutExtensionData:e,extension:a})=>{const{setExtensionData:r}=e,[k,_]=(0,i.useState)([]),[d,h]=(0,i.useState)({rate:{}}),[m,f]=(0,i.useState)({main:!1,custom:!1}),[g,w]=(0,i.useState)([]),b="pakettikauppa_pickup_point",[E,v]=(0,i.useState)(""),S=(e=>{const[t,p]=(0,i.useState)(e);return(0,i.useEffect)((()=>{const t=setTimeout((()=>{p(e)}),2e3);return()=>{clearTimeout(t)}}),[e,2e3]),t})(E),[y,C]=(0,i.useState)(""),[x,N]=(0,i.useState)(""),{setValidationErrors:P,clearValidationError:j}=(0,p.useDispatch)("wc/store/validation"),F=(0,p.useSelect)((e=>e("wc/store/validation").getValidationError(b))),O=(0,p.useSelect)((e=>e("wc/store/cart").getCartData().shippingRates));function T(){f({main:!1,custom:!1})}return(0,i.useEffect)((()=>{O.length&&_((e=>{if(!e.length)return[];let t=[];for(let i=0;i<e.length;i++)if(e[i].shipping_rates)for(let p=0;p<e[i].shipping_rates.length;p++)e[i].shipping_rates[p].rate_id&&t.push(e[i].shipping_rates[p]);return t})(O))}),[O]),(0,i.useEffect)((()=>{if(k.length)for(let e=0;e<k.length;e++)if(k[e].selected){h({...d,rate:{id:k[e].rate_id,method:k[e].method_id,instance:k[e].instance_id},destination:s(O)}),f({...m,main:!0});break}}),[k]),(0,i.useEffect)((()=>{let e=!1,t=(e=>{let t=c();if("methods"in t)for(let i=0;i<t.methods.length;i++)if(t.methods[i].instance_id==e)return t.methods[i];return null})(d.rate.instance);JSON.stringify(t)!==JSON.stringify(d.method)&&(""!==d.rate.id&&null!==t&&d.rate.instance&&t.have_pickups&&(e=!0),h({...d,method:t,show_block:e}),f({...m,main:!0}))}),[d.rate]),(0,i.useEffect)((()=>{m.main&&null!==d.method&&(null!==d.destination&&d.method?.service?(v(""),((e,t)=>{let i=c();return"ajax_url"in i?fetch(`${i.ajax_url}?action=pakettikauppa_get_pickup_points`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:e,destination:t})}).then((e=>e.json())).catch((e=>(console.error("Error fetching pickup points:",e),[]))):(console.error("Failed to get ajax URL"),[])})(d.method.service,d.destination).then((e=>{let t=[];e.success?e.data?t=e.data:console.warn("[Pakettikauppa]","Failed to get pickup points:","Data parameter not received"):console.warn("[Pakettikauppa]","Failed to get pickup points:",e.data),JSON.stringify(t)!==JSON.stringify(d.pickup_points_list)&&h({...d,pickup_points_list:t,pickup_points_list_type:c().list_type,pickup_point:"",custom_address:"",show_custom:c().allow_custom_address})})),T()):console.warn("[Pakettikauppa]","Failed to update pickup points:","Method data or destination is empty"))}),[m]),(0,i.useEffect)((()=>{m.custom&&(null!==d.method?(((e,t)=>{let i=c();return"ajax_url"in i?fetch(`${i.ajax_url}?action=pakettikauppa_get_custom_pickup_points`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:e,address:t})}).then((e=>e.json())).catch((e=>(console.error("Error fetching pickup points:",e),[]))):(console.error("Failed to get ajax URL"),[])})(d.method.service,E).then((e=>{let t=[];e.success?e.data?t=e.data:console.warn("[Pakettikauppa]","Failed to get pickup points:","Data parameter not received"):console.warn("[Pakettikauppa]","Failed to get pickup points:",e.data),h({...d,pickup_points_list:t,pickup_point:"",custom_address:E})})),T()):console.warn("[Pakettikauppa]","Failed to update pickup points by custom address:","Method data is empty"))}),[m]),(0,i.useEffect)((()=>{null!==d.method&&(E.length?E.length<3||!u(E)||f({...m,custom:!0}):f({...m,main:!0}))}),[S]),(0,i.useEffect)((()=>{E.length>0&&E.length<3?C(n.custom_pickup_error_too_short):u(E)?C(""):C(n.custom_pickup_error_bad_char)}),[E]),(0,i.useEffect)((()=>{let e=[],t="";if("menu"===d.pickup_points_list_type&&(t="- "+n.pickup_select_field_default+" -"),l(d.rate.instance)||(t="- "+n.pickup_select_field_optional+" -"),""!==t&&e.push({label:t,value:""}),d.pickup_points_list?.length)for(let t=0;t<d.pickup_points_list.length;t++)e.push({label:d.pickup_points_list[t].name+" ("+d.pickup_points_list[t].street_address+")",value:d.pickup_points_list[t].provider+": "+d.pickup_points_list[t].name+" (#"+d.pickup_points_list[t].pickup_point_id+")"});d.show_custom&&e.push({label:n.pickup_select_other,value:"other"}),w(e)}),[d.pickup_points_list]),(0,i.useEffect)((()=>{F&&(j(b),N("")),d.rate?.instance&&(e=>{let t=c();if("methods"in t)for(let i=0;i<t.methods.length;i++)if(t.methods[i].instance_id==e&&t.methods[i].have_pickups)return!0;return!1})(d.rate.instance)&&l(d.rate.instance)&&(r("wc-pakettikauppa","pakettikauppa_pickup_point",d.pickup_point),""===d.pickup_point&&(P({[b]:{message:n.pickup_error,hidden:!1}}),N("error")))}),[r,d.rate?.id,d.pickup_point]),(0,i.useEffect)((()=>{}),[d]),d.show_block?(0,t.createElement)("div",{className:`pakettikauppa-block pakettikauppa-shipping-pickup-point ${x}`},d.pickup_points_list?.length?(0,t.createElement)(t.Fragment,null,"list"===d.pickup_points_list_type?(0,t.createElement)(o.RadioControl,{label:n.pickup_block_title,help:n.checkout_pickup_info,selected:d.pickup_point,options:g,onChange:e=>h({...d,pickup_point:e})}):(0,t.createElement)(o.SelectControl,{id:"pakettikauppa_pickup_point",label:n.pickup_block_title,help:n.checkout_pickup_info,value:d.pickup_point,options:g,onChange:e=>h({...d,pickup_point:e})}),F?.hidden||""!==d.pickup_point?null:(0,t.createElement)("div",{className:"wc-block-components-validation-error"},(0,t.createElement)("span",null,F?.message))):(0,t.createElement)(o.BaseControl,{label:n.pickup_block_title},(0,t.createElement)("p",null,n.pickup_not_found)),d.custom_address?(0,t.createElement)("p",{className:"pakettikauppa-custom-text"},n.custom_pickup_address.replaceAll("%s",'"'+d.custom_address+'"')):null,!d.show_custom||"other"!==d.pickup_point&&d.pickup_points_list?.length?null:(0,t.createElement)(t.Fragment,null,(0,t.createElement)(o.TextareaControl,{label:n.custom_pickup_title,help:n.custom_pickup_description+". "+n.custom_pickup_help+".",value:E,onChange:e=>v(e)}),""===y?null:(0,t.createElement)("div",{className:"wc-block-components-validation-error"},(0,t.createElement)("span",null,y)))):(0,t.createElement)(t.Fragment,null)}})})();
(()=>{"use strict";const e=window.wc.blocksCheckout,t=window.React,i=window.wp.element,p=window.wp.data,o=window.wp.components,a=window.wp.i18n,n=wcSettings["posti-blocks_data"].txt,s=((0,a.__)("Block options","woo-pakettikauppa"),(0,a.__)("Pickup point","woo-pakettikauppa"),(0,a.__)("Select a pickup point","woo-pakettikauppa"),(0,a.__)("Other","woo-pakettikauppa"),(0,a.__)("Please choose a pickup point","woo-pakettikauppa"),(0,a.__)("No pickup points were found. Check the address.","woo-pakettikauppa"),(0,a.__)("You can choose the pickup point on the Checkout page","woo-pakettikauppa"),(0,a.__)("Choose one of pickup points close to the address you entered","woo-pakettikauppa"),(0,a.__)("Custom pickup address","woo-pakettikauppa"),(0,a.__)("If none of your preferred pickup points are listed, fill in a custom address above and select another pickup point","woo-pakettikauppa"),(0,a.__)("After entering, please wait for a while for the results to be received","woo-pakettikauppa"),(0,a.__)("The value is too short","woo-pakettikauppa"),(0,a.__)("Invalid character entered","woo-pakettikauppa"),(0,a.__)("The selection of pickup points has been changed based on the address %s","woo-pakettikauppa"),(e,t=!0)=>{if(!e.length)return null;let i=[];for(let t=0;t<e.length;t++)e[t].destination&&i.push(e[t].destination);return i.length?t?i[0]:i:null}),c=()=>wcSettings&&wcSettings["posti-blocks_data"]?wcSettings["posti-blocks_data"]:[],l=e=>!/[`!@#$%^*_+=\[\]{};:|<>\/?~]/.test(e),u=JSON.parse('{"apiVersion":2,"name":"pakettikauppa/pickup-point-selection-checkout","version":"1.0.0","title":"Posti pickup point selection","category":"woocommerce","description":"Allow to add components for Pakettikauppa shipping method on Checkout page","parent":["woocommerce/checkout-shipping-methods-block"],"supports":{"html":false,"align":false,"multiple":false,"reusable":false},"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}},"text":{"type":"string","default":""}},"textdomain":"woo-pakettikauppa"}');(0,e.registerCheckoutBlock)({metadata:u,component:({checkoutExtensionData:e,extension:a})=>{const{setExtensionData:u}=e,[r,k]=(0,i.useState)([]),[_,d]=(0,i.useState)({rate:{}}),[h,m]=(0,i.useState)({main:!1,custom:!1}),[f,g]=(0,i.useState)([]),w="pakettikauppa_pickup_point",[b,E]=(0,i.useState)(""),v=((e,t)=>{const[p,o]=(0,i.useState)(e);return(0,i.useEffect)((()=>{const t=setTimeout((()=>{o(e)}),2e3);return()=>{clearTimeout(t)}}),[e,2e3]),p})(b),[S,y]=(0,i.useState)(""),[C,x]=(0,i.useState)(""),{setValidationErrors:N,clearValidationError:P}=(0,p.useDispatch)("wc/store/validation"),j=(0,p.useSelect)((e=>e("wc/store/validation").getValidationError(w))),F=(0,p.useSelect)((e=>e("wc/store/cart").getCartData().shippingRates));function O(){m({main:!1,custom:!1})}return(0,i.useEffect)((()=>{F.length&&k((e=>{if(!e.length)return[];let t=[];for(let i=0;i<e.length;i++)if(e[i].shipping_rates)for(let p=0;p<e[i].shipping_rates.length;p++)e[i].shipping_rates[p].rate_id&&t.push(e[i].shipping_rates[p]);return t})(F))}),[F]),(0,i.useEffect)((()=>{if(r.length)for(let e=0;e<r.length;e++)if(r[e].selected){d({..._,rate:{id:r[e].rate_id,method:r[e].method_id,instance:r[e].instance_id},destination:s(F)}),m({...h,main:!0});break}}),[r]),(0,i.useEffect)((()=>{let e=!1,t=(e=>{let t=c();if("methods"in t)for(let i=0;i<t.methods.length;i++)if(t.methods[i].instance_id==e)return t.methods[i];return null})(_.rate.instance);JSON.stringify(t)!==JSON.stringify(_.method)&&(""!==_.rate.id&&null!==t&&_.rate.instance&&t.have_pickups&&(e=!0),d({..._,method:t,show_block:e}),m({...h,main:!0}))}),[_.rate]),(0,i.useEffect)((()=>{h.main&&null!==_.method&&(null!==_.destination&&_.method?.service?(E(""),((e,t,i=null)=>{let p=c();return"ajax_url"in p?fetch(`${p.ajax_url}?action=pakettikauppa_get_pickup_points`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:e,destination:t})}).then((e=>e.json())).catch((e=>(console.error("Error fetching pickup points:",e),[]))):(console.error("Failed to get ajax URL"),[])})(_.method.service,_.destination).then((e=>{let t=[];e.success?e.data?t=e.data:console.warn("[Pakettikauppa]","Failed to get pickup points:","Data parameter not received"):console.warn("[Pakettikauppa]","Failed to get pickup points:",e.data),JSON.stringify(t)!==JSON.stringify(_.pickup_points_list)&&d({..._,pickup_points_list:t,pickup_points_list_type:c().list_type,pickup_point:"",custom_address:"",show_custom:c().allow_custom_address})})),O()):console.warn("[Pakettikauppa]","Failed to update pickup points:","Method data or destination is empty"))}),[h]),(0,i.useEffect)((()=>{h.custom&&(null!==_.method?(((e,t,i=null)=>{let p=c();return"ajax_url"in p?fetch(`${p.ajax_url}?action=pakettikauppa_get_custom_pickup_points`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:e,address:t})}).then((e=>e.json())).catch((e=>(console.error("Error fetching pickup points:",e),[]))):(console.error("Failed to get ajax URL"),[])})(_.method.service,b).then((e=>{let t=[];e.success?e.data?t=e.data:console.warn("[Pakettikauppa]","Failed to get pickup points:","Data parameter not received"):console.warn("[Pakettikauppa]","Failed to get pickup points:",e.data),d({..._,pickup_points_list:t,pickup_point:"",custom_address:b})})),O()):console.warn("[Pakettikauppa]","Failed to update pickup points by custom address:","Method data is empty"))}),[h]),(0,i.useEffect)((()=>{null!==_.method&&(b.length?b.length<3||!l(b)||m({...h,custom:!0}):m({...h,main:!0}))}),[v]),(0,i.useEffect)((()=>{b.length>0&&b.length<3?y(n.custom_pickup_error_too_short):l(b)?y(""):y(n.custom_pickup_error_bad_char)}),[b]),(0,i.useEffect)((()=>{let e=[];if("menu"===_.pickup_points_list_type&&e.push({label:"- "+n.pickup_select_field_default+" -",value:""}),_.pickup_points_list?.length)for(let t=0;t<_.pickup_points_list.length;t++)e.push({label:_.pickup_points_list[t].name+" ("+_.pickup_points_list[t].street_address+")",value:_.pickup_points_list[t].provider+": "+_.pickup_points_list[t].name+" (#"+_.pickup_points_list[t].pickup_point_id+")"});_.show_custom&&e.push({label:n.pickup_select_other,value:"other"}),g(e)}),[_.pickup_points_list]),(0,i.useEffect)((()=>{j&&(P(w),x("")),_.rate?.instance&&(e=>{let t=c();if("methods"in t)for(let i=0;i<t.methods.length;i++)if(t.methods[i].instance_id==e&&t.methods[i].have_pickups)return!0;return!1})(_.rate.instance)&&(u("wc-pakettikauppa","pakettikauppa_pickup_point",_.pickup_point),""===_.pickup_point&&(N({[w]:{message:n.pickup_error,hidden:!1}}),x("error")))}),[u,_.rate?.id,_.pickup_point]),(0,i.useEffect)((()=>{}),[_]),_.show_block?(0,t.createElement)("div",{className:`pakettikauppa-block pakettikauppa-shipping-pickup-point ${C}`},_.pickup_points_list?.length?(0,t.createElement)(t.Fragment,null,"list"===_.pickup_points_list_type?(0,t.createElement)(o.RadioControl,{label:n.pickup_block_title,help:n.checkout_pickup_info,selected:_.pickup_point,options:f,onChange:e=>d({..._,pickup_point:e})}):(0,t.createElement)(o.SelectControl,{id:"pakettikauppa_pickup_point",label:n.pickup_block_title,help:n.checkout_pickup_info,value:_.pickup_point,options:f,onChange:e=>d({..._,pickup_point:e})}),j?.hidden||""!==_.pickup_point?null:(0,t.createElement)("div",{className:"wc-block-components-validation-error"},(0,t.createElement)("span",null,j?.message))):(0,t.createElement)(o.BaseControl,{label:n.pickup_block_title},(0,t.createElement)("p",null,n.pickup_not_found)),_.custom_address?(0,t.createElement)("p",{className:"pakettikauppa-custom-text"},n.custom_pickup_address.replaceAll("%s",'"'+_.custom_address+'"')):null,!_.show_custom||"other"!==_.pickup_point&&_.pickup_points_list?.length?null:(0,t.createElement)(t.Fragment,null,(0,t.createElement)(o.TextareaControl,{label:n.custom_pickup_title,help:n.custom_pickup_description+". "+n.custom_pickup_help+".",value:b,onChange:e=>E(e)}),""===S?null:(0,t.createElement)("div",{className:"wc-block-components-validation-error"},(0,t.createElement)("span",null,S)))):(0,t.createElement)(t.Fragment,null)}})})();